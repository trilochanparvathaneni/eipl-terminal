generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  TERMINAL_ADMIN
  CLIENT
  TRANSPORTER
  SECURITY
  SURVEYOR
  HSE_OFFICER
  AUDITOR
  TRAFFIC_CONTROLLER
}

enum ProductCategory {
  LPG
  POL
  CHEMICAL
}

enum BookingStatus {
  DRAFT
  SUBMITTED
  CLIENT_APPROVED
  OPS_SCHEDULED
  TRUCK_DETAILS_PENDING
  QR_ISSUED
  ARRIVED_GATE
  IN_TERMINAL
  LOADED
  EXITED
  CLOSED
  REJECTED
  CANCELLED
  STOP_WORK
}

enum TruckTripStatus {
  PENDING
  QR_ISSUED
  ARRIVED
  IN_TERMINAL
  LOADED
  EXITED
  COMPLETED
}

enum GateEventType {
  CHECK_IN
  CHECK_OUT
}

enum ChecklistStatus {
  PENDING
  PASSED
  FAILED
}

enum IncidentSeverity {
  LOW
  MED
  HIGH
}

enum IncidentStatus {
  OPEN
  CLOSED
}

enum NotificationChannel {
  EMAIL
  IN_APP
}

// ── AI Operations Enums ─────────────────────────────────────────────────────

enum BayStatus {
  IDLE
  OCCUPIED
  BLOCKED
  MAINTENANCE
}

enum ChangeoverState {
  NOT_ALLOWED
  NEEDS_CLEARANCE
  READY_FOR_CHANGEOVER
  IN_CHANGEOVER
}

enum PriorityClass {
  APPOINTMENT
  FCFS
  RECLASSIFIED
  BLOCKED
}

enum AIRecType {
  BAY_ASSIGNMENT
  QUEUE_RESEQUENCE
  ETA_UPDATE
}

enum EtaSource {
  MANUAL_HOURS_AWAY
  LOCATION_SHARE
  OPS_ESTIMATE
}

enum BayAllowedMode {
  POL
  LPG
}

enum ScheduleBlockStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ScheduleBlockSource {
  AI_SUGGESTED
  CONTROLLER_CONFIRMED
  SYSTEM_DEFAULT
}

// ── Compliance Enums ────────────────────────────────────────────────────────

enum CustodyStage {
  GATE_CHECKIN
  SAFETY_APPROVED
  DOCUMENTS_VERIFIED
  WEIGH_IN
  READY_FOR_BAY
  LOADING_STARTED
  LOADING_COMPLETED
  WEIGH_OUT
  SEALED
  CUSTODY_TRANSFERRED
  EXITED
}

enum TripEventType {
  STAGE_CHANGE
  DOC_UPLOADED
  DOC_VERIFIED
  DOC_REJECTED
  COMPLIANCE_BLOCKED
  COMPLIANCE_CLEARED
  STOP_WORK_ISSUED
  STOP_WORK_RESOLVED
  ARM_ASSIGNED
  WEIGH_IN_RECORDED
  WEIGH_OUT_RECORDED
}

enum DocumentVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum DocumentLinkType {
  BOOKING
  TRUCK_TRIP
  PRODUCT
  CLIENT
}

enum ComplianceGateType {
  SAFETY
  DOCUMENTS
  STOP_WORK
  WEIGHMENT
  SURVEYOR
  CUSTOMS
}

enum ComplianceGateStatus {
  PASS
  FAIL
  BLOCKED
}

// ── Core Models ─────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role
  isActive     Boolean  @default(true)
  clientId     String?
  transporterId String?
  terminalId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client      Client?      @relation(fields: [clientId], references: [id])
  transporter Transporter? @relation(fields: [transporterId], references: [id])
  terminal    Terminal?    @relation(fields: [terminalId], references: [id])

  bookingsCreated      Booking[]           @relation("BookingCreator")
  bayAllocations       BookingBayAllocation[] @relation("Allocator")
  gateEvents           GateEvent[]         @relation("SecurityUser")
  safetyChecklists     SafetyChecklist[]   @relation("HseCreator")
  stopWorkOrders       StopWorkOrder[]     @relation("StopWorkIssuer")
  incidentsReported    Incident[]          @relation("IncidentReporter")
  notifications        Notification[]
  auditLogs            AuditLog[]          @relation("AuditActor")
  aiRecommendations    AIRecommendation[]  @relation("AICreator")
  tripEvents           TripEvent[]         @relation("TripEventActor")
  documentsVerified    DocumentRecord[]    @relation("DocVerifier")
  complianceEvaluations ComplianceGateResult[] @relation("ComplianceEvaluator")
  evidencePacksGenerated EvidencePack[]    @relation("EvidenceGenerator")
  chatConversations    ChatConversation[]
  formSubmissions      FormSubmission[]
  chatLogs             ChatLog[]

  // Communications back-relations
  conversationsCreated    Conversation[]         @relation("ConvCreator")
  conversationMemberships ConversationMember[]
  commMessagesSent        CommMessage[]          @relation("MessageSender")
  mentionsReceived        MessageMention[]       @relation("MentionedUser")
  tasksAssigned           Task[]                 @relation("TaskAssignee")
  tasksCreated            Task[]                 @relation("TaskCreator")
  knowledgeDocsCreated    KnowledgeDocument[]    @relation("KnowledgeDocCreator")

  @@index([role])
  @@index([email])
}

model Client {
  id       String  @id @default(cuid())
  name     String
  email    String
  phone    String?
  address  String?
  isActive Boolean @default(true)

  users         User[]
  inventoryLots InventoryLot[]
  bookings      Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transporter {
  id       String  @id @default(cuid())
  name     String
  email    String
  phone    String?
  address  String?
  isActive Boolean @default(true)

  users    User[]
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String          @id @default(cuid())
  name        String
  category    ProductCategory
  isHazardous Boolean         @default(false)

  inventoryLots           InventoryLot[]
  productBayMaps          ProductBayMap[]
  bookings                Booking[]
  bayCurrentProduct       Bay[]                @relation("BayCurrentProduct")
  bayLastProduct          Bay[]                @relation("BayLastProduct")
  compatibilityFrom       ProductCompatibility[] @relation("CompatFrom")
  compatibilityTo         ProductCompatibility[] @relation("CompatTo")
  armCurrentProduct       LoadingArm[]         @relation("ArmCurrentProduct")
  armLastProduct          LoadingArm[]         @relation("ArmLastProduct")

  createdAt DateTime @default(now())
}

model InventoryLot {
  id                String  @id @default(cuid())
  clientId          String
  productId         String
  quantityAvailable Float
  uom               String  @default("KL")

  client  Client  @relation(fields: [clientId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  updatedAt DateTime @updatedAt

  @@unique([clientId, productId])
  @@index([clientId])
}

model Terminal {
  id       String @id @default(cuid())
  name     String
  location String

  /// Maximum trucks allowed inside the yard simultaneously (used by forecast engine)
  insideYardLimit   Int @default(8)
  /// Maximum trucks allowed in the outside queue simultaneously (used by forecast engine)
  outsideQueueLimit Int @default(15)

  gantries  Gantry[]
  timeSlots TimeSlot[]
  bookings  Booking[]
  incidents Incident[]
  users     User[]

  createdAt DateTime @default(now())
}

model Gantry {
  id         String @id @default(cuid())
  terminalId String
  name       String

  terminal Terminal @relation(fields: [terminalId], references: [id])
  bays     Bay[]

  @@index([terminalId])
}

// ── Bay (extended for AI operations) ────────────────────────────────────────

model Bay {
  id               String          @id @default(cuid())
  gantryId         String
  name             String
  uniqueCode       String          @unique
  allowedMode      BayAllowedMode  @default(POL)
  status           BayStatus       @default(IDLE)
  currentProductId String?
  lastProductId    String?
  changeoverState  ChangeoverState @default(NOT_ALLOWED)
  lastChangeoverAt DateTime?
  lockedByTripId   String?
  notes            String?

  gantry          Gantry              @relation(fields: [gantryId], references: [id])
  currentProduct  Product?            @relation("BayCurrentProduct", fields: [currentProductId], references: [id])
  lastProduct     Product?            @relation("BayLastProduct", fields: [lastProductId], references: [id])
  lockedByTrip    TruckTrip?          @relation("BayLock", fields: [lockedByTripId], references: [id])
  productBayMaps  ProductBayMap[]
  bayAllocations  BookingBayAllocation[]
  scheduleBlocks  BayScheduleBlock[]
  loadingArms     LoadingArm[]

  @@index([gantryId])
  @@index([status])
}

// ── Loading Arm (arm-level contamination control) ───────────────────────────

model LoadingArm {
  id               String          @id @default(cuid())
  bayId            String
  armNo            Int
  name             String?
  status           BayStatus       @default(IDLE)
  currentProductId String?
  lastProductId    String?
  changeoverState  ChangeoverState @default(NOT_ALLOWED)
  lastChangeoverAt DateTime?
  lockedByTripId   String?
  notes            String?

  bay             Bay      @relation(fields: [bayId], references: [id])
  currentProduct  Product? @relation("ArmCurrentProduct", fields: [currentProductId], references: [id])
  lastProduct     Product? @relation("ArmLastProduct", fields: [lastProductId], references: [id])
  bayAllocations  BookingBayAllocation[]

  @@unique([bayId, armNo])
  @@index([bayId])
}

model ProductBayMap {
  id        String  @id @default(cuid())
  productId String
  bayId     String
  isActive  Boolean @default(true)

  product Product @relation(fields: [productId], references: [id])
  bay     Bay     @relation(fields: [bayId], references: [id])

  @@unique([productId, bayId])
}

// ── Product Compatibility (contamination rules) ─────────────────────────────

model ProductCompatibility {
  id                   String  @id @default(cuid())
  fromProductId        String
  toProductId          String
  isCompatible         Boolean
  requiresFullClearance Boolean @default(true)
  minClearanceMinutes  Int     @default(60)
  notes                String?

  fromProduct Product @relation("CompatFrom", fields: [fromProductId], references: [id])
  toProduct   Product @relation("CompatTo", fields: [toProductId], references: [id])

  @@unique([fromProductId, toProductId])
}

model TimeSlot {
  id            String   @id @default(cuid())
  terminalId    String
  date          DateTime @db.Date
  startTime     String
  endTime       String
  capacityTrucks Int     @default(5)

  terminal Terminal  @relation(fields: [terminalId], references: [id])
  bookings Booking[]

  @@index([terminalId, date])
  @@index([date])
}

model Booking {
  id                 String        @id @default(cuid())
  bookingNo          String        @unique
  terminalId         String
  clientId           String
  productId          String
  quantityRequested  Float
  date               DateTime      @db.Date
  timeSlotId         String?
  transporterId      String?
  status             BookingStatus @default(DRAFT)
  isBulk             Boolean       @default(false)
  additionalRequests String?
  createdByUserId    String

  terminal    Terminal     @relation(fields: [terminalId], references: [id])
  client      Client       @relation(fields: [clientId], references: [id])
  product     Product      @relation(fields: [productId], references: [id])
  timeSlot    TimeSlot?    @relation(fields: [timeSlotId], references: [id])
  transporter Transporter? @relation(fields: [transporterId], references: [id])
  createdBy   User         @relation("BookingCreator", fields: [createdByUserId], references: [id])

  bayAllocations    BookingBayAllocation[]
  truckTrips        TruckTrip[]
  safetyChecklists  SafetyChecklist[]
  stopWorkOrders    StopWorkOrder[]
  incidents         Incident[]
  tripEvents        TripEvent[]
  complianceGates   ComplianceGateResult[]
  evidencePacks     EvidencePack[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([date])
  @@index([bookingNo])
  @@index([clientId])
  @@index([terminalId])
}

model BookingBayAllocation {
  id              String   @id @default(cuid())
  bookingId       String
  bayId           String
  armId           String?
  allocatedByUserId String
  allocatedAt     DateTime @default(now())

  booking     Booking     @relation(fields: [bookingId], references: [id])
  bay         Bay         @relation(fields: [bayId], references: [id])
  arm         LoadingArm? @relation(fields: [armId], references: [id])
  allocatedBy User        @relation("Allocator", fields: [allocatedByUserId], references: [id])

  @@index([bookingId])
  @@index([bayId])
  @@index([armId])
}

// ── TruckTrip (extended for compliance) ─────────────────────────────────────

model TruckTrip {
  id                    String          @id @default(cuid())
  bookingId             String
  truckNumber           String
  driverName            String
  driverPhone           String
  qrToken               String?         @unique
  status                TruckTripStatus @default(PENDING)

  // Custody & compliance fields
  custodyStage          CustodyStage    @default(GATE_CHECKIN)

  // AI operations fields
  etaMinutes            Int?
  etaSource             EtaSource?
  etaUpdatedAt          DateTime?
  appointmentStart      DateTime?
  appointmentEnd        DateTime?
  lateToleranceMinutes  Int             @default(45)
  priorityClass         PriorityClass   @default(FCFS)
  readyForBayAt         DateTime?
  queuePosition         Int?
  predictedStartTime    DateTime?
  riskFlags             Json?

  booking        Booking          @relation(fields: [bookingId], references: [id])
  gateEvents     GateEvent[]
  scheduleBlocks BayScheduleBlock[]
  bayLocks       Bay[]            @relation("BayLock")
  tripEvents     TripEvent[]
  complianceGates ComplianceGateResult[]
  evidencePacks  EvidencePack[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([qrToken])
  @@index([priorityClass])
  @@index([status])
  @@index([custodyStage])
}

model GateEvent {
  id              String        @id @default(cuid())
  truckTripId     String
  type            GateEventType
  timestamp       DateTime      @default(now())
  securityUserId  String
  payloadJson     Json?
  photoTruckUrl   String?
  photoDriverUrl  String?
  weighmentTare   Float?
  weighmentGross  Float?
  netQuantity     Float?

  truckTrip TruckTrip @relation(fields: [truckTripId], references: [id])
  security  User      @relation("SecurityUser", fields: [securityUserId], references: [id])

  @@index([truckTripId])
  @@index([timestamp])
}

// ── Bay Schedule Block (availability timeline) ──────────────────────────────

model BayScheduleBlock {
  id             String              @id @default(cuid())
  bayId          String
  truckTripId    String
  startPlannedAt DateTime
  endPlannedAt   DateTime
  startActualAt  DateTime?
  endActualAt    DateTime?
  status         ScheduleBlockStatus @default(PLANNED)
  source         ScheduleBlockSource @default(SYSTEM_DEFAULT)

  bay       Bay       @relation(fields: [bayId], references: [id])
  truckTrip TruckTrip @relation(fields: [truckTripId], references: [id])

  @@index([bayId, startPlannedAt])
  @@index([truckTripId])
  @@index([status])
}

// ── AI Recommendation (audit trail) ─────────────────────────────────────────

model AIRecommendation {
  id              String    @id @default(cuid())
  type            AIRecType
  inputSnapshot   Json
  outputJson      Json
  confidence      Float?
  reasonCodes     String[]
  createdByUserId String
  appliedAt       DateTime?
  appliedByAction String?

  createdBy User @relation("AICreator", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
}

// ── Trip Event Ledger (append-only, immutable) ──────────────────────────────

model TripEvent {
  id            String        @id @default(cuid())
  truckTripId   String
  bookingId     String?
  type          TripEventType
  stage         CustodyStage?
  message       String?
  payloadJson   Json?
  actorUserId   String
  createdAt     DateTime      @default(now())

  truckTrip TruckTrip @relation(fields: [truckTripId], references: [id])
  booking   Booking?  @relation(fields: [bookingId], references: [id])
  actor     User      @relation("TripEventActor", fields: [actorUserId], references: [id])

  @@index([truckTripId, createdAt])
}

// ── Document Governance ─────────────────────────────────────────────────────

model DocumentType {
  id             String           @id @default(cuid())
  code           String           @unique
  name           String
  description    String?
  isMandatory    Boolean          @default(false)
  expiryRequired Boolean          @default(false)
  versioned      Boolean          @default(true)
  allowedLinkTypes DocumentLinkType[]
  createdAt      DateTime         @default(now())

  documents DocumentRecord[]
}

model DocumentRecord {
  id                 String                     @id @default(cuid())
  documentTypeId     String
  linkType           DocumentLinkType
  linkId             String
  version            Int                        @default(1)
  fileUrl            String
  checksum           String?
  extractedMetadata  Json?
  verificationStatus DocumentVerificationStatus @default(PENDING)
  verifiedByUserId   String?
  verifiedAt         DateTime?
  expiryDate         DateTime?
  rejectionReason    String?

  documentType DocumentType @relation(fields: [documentTypeId], references: [id])
  verifiedBy   User?        @relation("DocVerifier", fields: [verifiedByUserId], references: [id])
  chunks       DocumentChunk[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([linkType, linkId])
  @@index([documentTypeId, verificationStatus])
}

// ── Compliance Gate Results ─────────────────────────────────────────────────

model ComplianceGateResult {
  id              String               @id @default(cuid())
  truckTripId     String
  bookingId       String?
  gateType        ComplianceGateType
  status          ComplianceGateStatus
  reason          String?
  detailsJson     Json?
  evaluatedByUserId String?
  evaluatedAt     DateTime             @default(now())

  truckTrip   TruckTrip @relation(fields: [truckTripId], references: [id])
  booking     Booking?  @relation(fields: [bookingId], references: [id])
  evaluatedBy User?     @relation("ComplianceEvaluator", fields: [evaluatedByUserId], references: [id])

  @@index([truckTripId, gateType])
}

// ── Evidence Pack ───────────────────────────────────────────────────────────

model EvidencePack {
  id                String   @id @default(cuid())
  truckTripId       String
  bookingId         String?
  status            String   @default("GENERATED")
  fileUrl           String?
  sha256            String?
  generatedByUserId String?
  generatedAt       DateTime @default(now())

  truckTrip   TruckTrip @relation(fields: [truckTripId], references: [id])
  booking     Booking?  @relation(fields: [bookingId], references: [id])
  generatedBy User?     @relation("EvidenceGenerator", fields: [generatedByUserId], references: [id])

  @@index([truckTripId, generatedAt])
}

// ── Safety Models ───────────────────────────────────────────────────────────

model SafetyChecklist {
  id             String          @id @default(cuid())
  bookingId      String
  createdByHseId String
  status         ChecklistStatus @default(PENDING)
  checklistJson  Json

  booking   Booking @relation(fields: [bookingId], references: [id])
  createdBy User    @relation("HseCreator", fields: [createdByHseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
}

model StopWorkOrder {
  id            String   @id @default(cuid())
  bookingId     String
  issuedByHseId String
  reason        String
  active        Boolean  @default(true)

  booking  Booking @relation(fields: [bookingId], references: [id])
  issuedBy User    @relation("StopWorkIssuer", fields: [issuedByHseId], references: [id])

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@index([bookingId])
  @@index([active])
}

model Incident {
  id              String           @id @default(cuid())
  terminalId      String
  bookingId       String?
  reportedByUserId String
  severity        IncidentSeverity
  description     String
  status          IncidentStatus   @default(OPEN)

  terminal   Terminal @relation(fields: [terminalId], references: [id])
  booking    Booking? @relation(fields: [bookingId], references: [id])
  reportedBy User     @relation("IncidentReporter", fields: [reportedByUserId], references: [id])

  createdAt DateTime  @default(now())
  closedAt  DateTime?

  @@index([terminalId])
  @@index([status])
}

model Notification {
  id      String              @id @default(cuid())
  userId  String
  channel NotificationChannel
  subject String
  body    String
  readAt  DateTime?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, readAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  /// Immutable terminal scope stamped at write time. Null for SUPER_ADMIN global actions.
  terminalId  String?
  entityType  String
  entityId    String
  action      String
  beforeJson  Json?
  afterJson   Json?
  ipAddress   String?

  actor User @relation("AuditActor", fields: [actorUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([actorUserId])
  @@index([createdAt])
  @@index([terminalId])
}

// ── Communications Enums ─────────────────────────────────────────────────────

enum ConvContextType {
  BOOKING
  CLIENT
  TRANSPORTER
  INCIDENT
}

enum ConvAudience {
  INTERNAL_ONLY
  MIXED
}

enum MemberRole {
  OWNER
  MEMBER
}

enum MentionType {
  INTERNAL
  EXTERNAL
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskVisibility {
  INTERNAL_ONLY
  SHARED_WITH_CLIENT
}

// ── Chat & RAG ────────────────────────────────────────────────────────────

enum FormSubmissionStatus {
  DRAFT
  CONFIRMED
}

model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id])
  messages ChatMessage[]

  @@index([userId, updatedAt])
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // "user" | "assistant" | "tool"
  content        String?
  toolCallId     String?
  toolName       String?
  metadata       Json?
  createdAt      DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model ChatLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  userMessage String
  botResponse String
  urgency     String
  intent      String?
  isPublicFAQ Boolean  @default(false)
  userId      String?

  user User? @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([urgency])
  @@index([userId])
}

model DocumentChunk {
  id               String   @id @default(cuid())
  documentRecordId String
  chunkIndex       Int
  chunkText        String
  metadata         Json?
  createdAt        DateTime @default(now())

  documentRecord DocumentRecord @relation(fields: [documentRecordId], references: [id], onDelete: Cascade)

  @@index([documentRecordId])
}

model FormSubmission {
  id               String               @id @default(cuid())
  userId           String
  formType         String
  formData         Json
  extractedData    Json?
  documentRecordId String?
  status           FormSubmissionStatus  @default(DRAFT)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, formType])
}

// ── Communications Models ────────────────────────────────────────────────────

model Conversation {
  id              String           @id @default(cuid())
  title           String
  audience        ConvAudience     @default(INTERNAL_ONLY)
  createdByUserId String
  createdAt       DateTime         @default(now())

  contextType     ConvContextType? // linked business entity type
  contextId       String?          // ID of the linked entity
  contextLabel    String?          // denormalized display name

  createdBy User                 @relation("ConvCreator", fields: [createdByUserId], references: [id])
  members   ConversationMember[]
  messages  CommMessage[]

  @@index([createdByUserId])
  @@index([audience])
  @@index([contextType, contextId])
}

model ConversationMember {
  conversationId String
  userId         String
  memberRole     MemberRole @default(MEMBER)
  joinedAt       DateTime   @default(now())
  lastReadAt     DateTime?  // track per-member read position

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@id([conversationId, userId])
  @@index([userId])
}

model CommMessage {
  id             String    @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime  @default(now())
  deletedAt      DateTime?

  conversation Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User             @relation("MessageSender", fields: [senderId], references: [id])
  mentions     MessageMention[]
  taskLinks    TaskLink[]

  @@index([conversationId, createdAt(sort: Desc)])
}

model MessageMention {
  id              String      @id @default(cuid())
  messageId       String
  mentionedUserId String
  mentionType     MentionType
  createdAt       DateTime    @default(now())
  digestedAt      DateTime?   // marks mention as sent in a digest email

  message       CommMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  mentionedUser User        @relation("MentionedUser", fields: [mentionedUserId], references: [id])

  @@index([messageId])
  @@index([mentionedUserId])
  @@index([digestedAt])
}

model Task {
  id              String         @id @default(cuid())
  title           String
  description     String?
  assigneeId      String?
  createdByUserId String
  dueAt           DateTime?
  priority        TaskPriority   @default(MEDIUM)
  status          TaskStatus     @default(OPEN)
  visibility      TaskVisibility @default(INTERNAL_ONLY)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  assignee   User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdBy  User       @relation("TaskCreator", fields: [createdByUserId], references: [id])
  taskLinks  TaskLink[]

  @@index([assigneeId])
  @@index([createdByUserId])
  @@index([status])
}

model TaskLink {
  taskId         String
  conversationId String
  messageId      String

  task    Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  message CommMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@id([taskId, conversationId, messageId])
  @@index([conversationId])
  @@index([messageId])
}

// ── Knowledge Base (RAG) ─────────────────────────────────────────────────────

/// SOP / compliance documents uploaded to the org-scoped knowledge base.
model KnowledgeDocument {
  id              String   @id @default(cuid())
  orgSlug         String
  title           String
  sourceType      String   @default("UPLOAD") // UPLOAD | SEED
  storagePath     String
  permissions     String   @default("INTERNAL_ONLY") // INTERNAL_ONLY | ORG_ONLY
  createdByUserId String
  createdAt       DateTime @default(now())

  createdBy User             @relation("KnowledgeDocCreator", fields: [createdByUserId], references: [id])
  chunks    KnowledgeChunk[]

  @@index([orgSlug])
}

/// Text chunks with pgvector embeddings for semantic RAG retrieval.
/// The `embedding` column (vector(1536)) is added by raw migration SQL.
model KnowledgeChunk {
  id         String   @id @default(cuid())
  documentId String
  orgSlug    String
  chunkIndex Int
  chunkText  String
  createdAt  DateTime @default(now())

  document KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([orgSlug])
}
